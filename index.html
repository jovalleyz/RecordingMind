<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeetingMind</title>
    
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuración de Tailwind y Fuentes -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'brand': {
                            'light': '#67e8f9',
                            'DEFAULT': '#06b6d4',
                            'dark': '#0e7490'
                        },
                        'gray': {
                            '950': '#0C111A',
                            '900': '#111827',
                            '800': '#1F2937',
                            '700': '#374151',
                            '600': '#4B5567',
                            '500': '#6B7280',
                            '400': '#9CA3AF',
                            '300': '#D1D5DB',
                            '200': '#E5E7EB',
                            '100': '#F3F4F6',
                            '50': '#F9FAFB',
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Manifiesto de la PWA (enlazado a archivo externo) -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Estilos Globales y Animaciones -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        
        /* Ocultar scrollbars */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animación de pulso para grabación */
        .pulse-live {
            animation: pulse-live-animation 2s infinite;
        }
        @keyframes pulse-live-animation {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        /* Indicador de nivel de audio */
        #audio-level-visualizer {
            width: 100%;
            height: 4px;
            background-color: #374151;
            border-radius: 2px;
            transition: all 0.1s ease-in-out;
            transform-origin: left;
            transform: scaleX(0);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-full overflow-hidden">

    <!-- Contenedor principal de la App -->
    <div id="app-container" class="h-full flex flex-col max-w-lg mx-auto shadow-2xl">

        <!-- Área de Contenido Principal (Scrollable) -->
        <main id="main-content" class="flex-grow overflow-y-auto no-scrollbar pb-20 bg-gray-950">
            
            <!-- PÁGINA: GRABAR -->
            <div id="page-record" class="page p-6 flex flex-col h-full">
                <h1 class="text-3xl font-bold text-white mb-4">Grabar Reunión</h1>
                <p class="text-gray-400 mb-6">Presiona el botón para iniciar una nueva grabación. El audio se procesará localmente.</p>
                
                <div class="flex-grow flex flex-col items-center justify-center space-y-8">
                    <button id="record-button" class="relative w-40 h-40 bg-gray-800 rounded-full flex items-center justify-center shadow-lg transition-all duration-300 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed group">
                        <!-- Micrófono Icono -->
                        <svg id="record-icon" class="w-16 h-16 text-gray-400 group-enabled:group-hover:text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 18.75a6 6 0 0 0 6-6v-1.5m-6 7.5a6 6 0 0 1-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15c-3.314 0-6-2.686-6-6v-1.5a6 6 0 0 1 12 0v1.5c0 3.314-2.686 6-6 6Z" />
                        </svg>
                        <!-- Stop Icono -->
                        <svg id="stop-icon" class="w-12 h-12 text-red-500 hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.5 7.5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-9a3 3 0 0 1-3-3v-9Z" clip-rule="evenodd" />
                        </svg>
                        <span id="record-ring" class="hidden absolute inset-0 w-full h-full bg-red-600 rounded-full pulse-live z-0"></span>
                    </button>

                    <div class="text-center">
                        <div id="timer" class="text-4xl font-bold text-white">00:00:00</div>
                        <div id="record-status" class="text-gray-400">Presiona para grabar</div>
                    </div>

                    <!-- Visualizador de Nivel (simple) -->
                    <div class="w-full h-2 bg-gray-800 rounded-full overflow-hidden">
                        <div id="audio-level-visualizer"></div>
                    </div>
                </div>

                <div class="mt-8">
                    <!-- Advertencia de Pantalla Activa (Plan A) -->
                    <div id="screen-on-warning" class="bg-yellow-900 border border-yellow-700 text-yellow-200 px-4 py-3 rounded-lg text-sm mb-4">
                        <strong class="font-bold">¡Atención!</strong>
                        <span class="block sm:inline"> Para asegurar la grabación, mantén la pantalla encendida y la app en primer plano.</span>
                    </div>

                    <!-- Consentimiento Legal -->
                    <div class="flex items-start space-x-3 bg-gray-800 p-4 rounded-lg">
                        <input id="consent-checkbox" type="checkbox" class="h-5 w-5 mt-0.5 rounded bg-gray-700 border-gray-600 text-brand focus:ring-brand">
                        <div>
                            <label for="consent-checkbox" class="text-gray-100">Confirmo que todos los participantes consienten la grabación.</label>
                            <p class="text-xs text-gray-400 mt-1">Es tu responsabilidad cumplir con las leyes de privacidad y consentimiento.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- PÁGINA: HISTORIAL -->
            <div id="page-history" class="page p-6 hidden">
                <h1 class="text-3xl font-bold text-white mb-6">Historial</h1>
                <div class="relative mb-6">
                    <input type="search" id="search-bar" class="w-full bg-gray-800 border-gray-700 rounded-lg pl-10 pr-4 py-2 text-white placeholder-gray-500 focus:ring-brand focus:border-brand" placeholder="Buscar por título, tema, palabra...">
                    <svg class="w-5 h-5 text-gray-500 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 1 0 0 11 5.5 5.5 0 0 0 0-11ZM2 9a7 7 0 1 1 12.452 4.391l3.328 3.329a.75.75 0 1 1-1.06 1.06l-3.329-3.328A7 7 0 0 1 2 9Z" clip-rule="evenodd" />
                    </svg>
                </div>
                
                <div class="space-y-4">
                    <ul id="history-list" class="space-y-4">
                        <!-- Plantilla de reunión (se llena con JS) -->
                    </ul>
                    <p id="history-empty-state" class="text-center text-gray-500 py-10 hidden">No tienes grabaciones.<br>Inicia una en la pestaña "Grabar".</p>
                </div>
            </div>

            <!-- PÁGINA: DASHBOARD -->
            <div id="page-dashboard" class="page p-6 hidden">
                <h1 class="text-3xl font-bold text-white mb-6">Dashboard</h1>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <div class="text-sm text-gray-400">Tiempo en reuniones (mes)</div>
                        <div id="kpi-total-time" class="text-2xl font-bold text-white">0h 0m</div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <div class="text-sm text-gray-400">Efectividad (promedio)</div>
                        <div id="kpi-avg-effectiveness" class="text-2xl font-bold text-white">N/A</div>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg col-span-2">
                        <div class="text-sm text-gray-400">% con Plan de Acción</div>
                        <div id="kpi-action-items-pct" class="text-2xl font-bold text-white">0%</div>
                    </div>
                </div>

                <h2 class="text-xl font-semibold text-white mb-4">Temas Frecuentes</h2>
                <div id="topics-chart-container" class="bg-gray-800 p-4 rounded-lg min-h-[150px] flex items-center justify-center">
                    <p class="text-gray-500" id="topics-empty-state">No hay datos de temas aún.</p>
                    <!-- Aquí se generaría un gráfico (p.ej. barras con Tailwind) -->
                </div>

                <h2 class="text-xl font-semibold text-white mt-6 mb-4">Tareas Abiertas</h2>
                <div id="tasks-list-container" class="bg-gray-800 p-4 rounded-lg min-h-[150px]">
                    <p class="text-gray-500" id="tasks-empty-state">No hay tareas pendientes.</p>
                    <ul id="tasks-list" class="space-y-3">
                        <!-- Plantilla de tarea -->
                    </ul>
                </div>
            </div>

            <!-- PÁGINA: PERFIL -->
            <div id="page-profile" class="page p-6 hidden">
                <h1 class="text-3xl font-bold text-white mb-6">Perfil y Ajustes</h1>
                
                <div class="bg-gray-800 p-4 rounded-lg flex items-center space-x-4 mb-6">
                    <img src="https://placehold.co/64x64/374151/F9FAFB?text=User" alt="Avatar" class="w-16 h-16 rounded-full bg-gray-700">
                    <div>
                        <h2 class="text-xl font-bold text-white">Usuario de Prueba</h2>
                        <p class="text-gray-400" id="user-id-display">ID: mock-user-123</p>
                    </div>
                </div>

                <h3 class="text-lg font-semibold text-white mb-4">Ajustes de Privacidad</h3>
                <div class="space-y-4 bg-gray-800 p-4 rounded-lg">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-300">Bloqueo con PIN (App)</span>
                        <button class="text-sm bg-gray-700 text-white px-3 py-1 rounded-md hover:bg-gray-600">Activar</button>
                    </div>
                    <div class="flex items-center justify-between">
                        <label for="auto-delete-toggle" class="text-gray-300">Auto-borrado (90 días)</label>
                        <input type="checkbox" id="auto-delete-toggle" class="toggle-checkbox">
                    </div>
                </div>

                <h3 class="text-lg font-semibold text-white mt-6 mb-4">Aplicación</h3>
                <div class="space-y-4 bg-gray-800 p-4 rounded-lg">
                    <button id="install-pwa-button" class="w-full text-center bg-brand text-white font-semibold px-4 py-2 rounded-lg hover:bg-brand-dark transition-colors hidden">
                        Instalar Aplicación
                    </button>
                    <button id="export-data-button" class="w-full text-center bg-gray-700 text-white font-semibold px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        Exportar Todos los Datos (JSON)
                    </button>
                    <button id="clear-data-button" class="w-full text-center bg-red-800 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">
                        Borrar Todos los Datos Locales
                    </button>
                </div>
            </div>

            <!-- PÁGINA: DETALLE DE REUNIÓN -->
            <div id="page-detail" class="page p-6 hidden">
                <button id="back-to-history" class="mb-4 text-brand-light flex items-center space-x-1 hover:text-brand">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                        <path fill-rule="evenodd" d="M11.78 5.22a.75.75 0 0 1 0 1.06L8.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06l-4.25-4.25a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                    </svg>
                    <span>Volver al Historial</span>
                </button>
                
                <h1 id="detail-title" class="text-3xl font-bold text-white mb-2">Cargando...</h1>
                <p id="detail-date" class="text-gray-400 mb-4">...</p>
                <div id="detail-tags" class="flex flex-wrap gap-2 mb-6"></div>

                <!-- Reproductor de Audio -->
                <audio id="detail-audio-player" controls class="w-full mb-6"></audio>

                <!-- Botón de IA -->
                <button id="process-ai-button" class_disabled="bg-gray-600 cursor-not-allowed" class="w-full bg-brand text-white font-bold py-3 px-4 rounded-lg mb-6 flex items-center justify-center space-x-2 hover:bg-brand-dark transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                        <path d="M10 3.5a1.5 1.5 0 0 1 3 0V5h-3V3.5Z" />
                        <path fill-rule="evenodd" d="M10 1.5a3.5 3.5 0 0 0-3.5 3.5V5H5a3 3 0 0 0-3 3v4.5a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a3 3 0 0 0-3-3h-1.5V5A3.5 3.5 0 0 0 10 1.5ZM5.75 8.75a.75.75 0 0 0 0 1.5h8.5a.75.75 0 0 0 0-1.5h-8.5Z" clip-rule="evenodd" />
                    </svg>
                    <span>Transcribir y Resumir (IA)</span>
                </button>
                <div id="ai-loading-spinner" class="text-center py-4 text-gray-400 hidden">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-brand-light mx-auto"></div>
                    <p class="mt-2">Procesando con IA... (Esto puede tardar)</p>
                    <p class="text-sm text-yellow-500">(STT simulado, llamando a Gemini para resumen...)</p>
                </div>


                <!-- Pestañas de Contenido -->
                <div class="mb-4 border-b border-gray-700">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button data-tab="summary" class="tab-button border-brand text-brand whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Minuta (IA)</button>
                        <button data-tab="transcript" class="tab-button border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Transcripción</button>
                        <button data-tab="actions" class="tab-button border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500 whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm">Acciones</button>
                    </nav>
                </div>

                <!-- Contenido Pestañas -->
                <div id="tab-content-container">
                    <!-- Minuta (IA) -->
                    <div id="tab-summary" class="tab-content space-y-5">
                        <div id="summary-empty-state" class="text-center text-gray-500 py-6">Procesa la reunión para generar una minuta.</div>
                        <div id="summary-content" class="hidden space-y-5">
                            <div>
                                <h3 class="font-semibold text-brand-light mb-1">Resumen General</h3>
                                <p id="summary-overview" class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap"></p>
                            </div>
                            <div>
                                <h3 class="font-semibold text-brand-light mb-1">Objetivo General</h3>
                                <p id="summary-objective" class="text-gray-200 text-sm leading-relaxed whitespace-pre-wrap"></p>
                            </div>
                            <div>
                                <h3 class="font-semibold text-brand-light mb-1">Desarrollo por Participante</h3>
                                <ul id="summary-participants" class="list-disc list-inside space-y-2 pl-2"></ul>
                            </div>
                            <div>
                                <h3 class="font-semibold text-brand-light mb-1">Puntos Relevantes</h3>
                                <ul id="summary-keypoints" class="list-disc list-inside space-y-2 pl-2"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Transcripción -->
                    <div id="tab-transcript" class="tab-content hidden space-y-4">
                        <div id="transcript-empty-state" class="text-center text-gray-500 py-6">Procesa la reunión para generar una transcripción.</div>
                        <div id="transcript-content" class="hidden">
                            <textarea id="transcript-text" class="w-full h-64 bg-gray-900 border border-gray-700 rounded-lg p-3 text-gray-200 text-sm focus:ring-brand focus:border-brand"></textarea>
                            <button id="save-transcript-button" class="mt-2 bg-brand text-white font-semibold px-4 py-2 rounded-lg text-sm hover:bg-brand-dark">Guardar Cambios</button>
                        </div>
                    </div>

                    <!-- Plan de Acción -->
                    <div id="tab-actions" class="tab-content hidden space-y-4">
                        <div id="actions-empty-state" class="text-center text-gray-500 py-6">No se extrajeron planes de acción.</div>
                        <div id="actions-content" class="hidden">
                            <ul id="summary-actionplan" class="space-y-3">
                                <!-- Plantilla Tarea -->
                            </ul>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Barra de Navegación Inferior -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-lg mx-auto bg-gray-800 border-t border-gray-700 h-20 flex justify-around items-center">
            <button class="nav-button flex flex-col items-center justify-center p-3 w-full" data-page="record">
                <!-- Icono Grabar -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-7 h-7">
                    <path d="M7 3.5A1.5 1.5 0 0 1 8.5 2h3A1.5 1.5 0 0 1 13 3.5v1.286a.75.75 0 0 1-1.5 0V3.5a.75.75 0 0 0-.75-.75h-1.5a.75.75 0 0 0-.75.75v1.286a.75.75 0 0 1-1.5 0V3.5Z" />
                    <path fill-rule="evenodd" d="M.75 6.75A.75.75 0 0 1 1.5 6h17a.75.75 0 0 1 .75.75v8.5a.75.75 0 0 1-.75.75h-17a.75.75 0 0 1-.75-.75v-8.5ZM18 15V7.5H2V15h16Z" clip-rule="evenodd" />
                </svg>
                <span class="text-xs font-medium mt-1">Grabar</span>
            </button>
            <button class="nav-button flex flex-col items-center justify-center p-3 w-full" data-page="history">
                <!-- Icono Historial -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-7 h-7">
                    <path fill-rule="evenodd" d="M2 3.5A1.5 1.5 0 0 1 3.5 2h1.148a1.5 1.5 0 0 1 1.465 1.175l.716 3.223a1.5 1.5 0 0 1-1.052 1.767l-.933.267c-.41.117-.643.555-.527.965l.33 1.21a1.5 1.5 0 0 0 1.518 1.102l1.78-.49a1.5 1.5 0 0 1 1.518 1.102l.33 1.21c.117.41-.217.848-.627.965l-.933.267a1.5 1.5 0 0 1-1.052 1.767l-.716 3.223A1.5 1.5 0 0 1 3.648 18H3.5A1.5 1.5 0 0 1 2 16.5v-13Z" clip-rule="evenodd" />
                    <path fill-rule="evenodd" d="M7.25 3a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-1.5 0V3.75a.75.75 0 0 1 .75-.75Zm3 0a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-1.5 0V3.75a.75.75 0 0 1 .75-.75Zm3 0a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-1.5 0V3.75a.75.75 0 0 1 .75-.75Zm3 0a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-1.5 0V3.75a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd" />
                </svg>
                <span class="text-xs font-medium mt-1">Historial</span>
            </button>
            <button class="nav-button flex flex-col items-center justify-center p-3 w-full" data-page="dashboard">
                <!-- Icono Dashboard -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-7 h-7">
                    <path fill-rule="evenodd" d="M2.5 3A1.5 1.5 0 0 0 1 4.5v11A1.5 1.5 0 0 0 2.5 17h15a1.5 1.5 0 0 0 1.5-1.5v-11A1.5 1.5 0 0 0 17.5 3h-15ZM3 7.5h14v8H3v-8Zm1.5-1.5a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1h-3ZM9 6a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 9 6Zm2 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 11 6Zm2 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 13 6Zm2 0a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-3A.5.5 0 0 1 15 6Z" clip-rule="evenodd" />
                </svg>
                <span class="text-xs font-medium mt-1">Dashboard</span>
            </button>
            <button class="nav-button flex flex-col items-center justify-center p-3 w-full" data-page="profile">
                <!-- Icono Perfil -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-7 h-7">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 1 1-16 0 8 8 0 0 1 16 0Zm-5.5-2.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0ZM10 12a5.99 5.99 0 0 0-4.793 2.39A6.483 6.483 0 0 0 10 16.5a6.483 6.483 0 0 0 4.793-2.11A5.99 5.99 0 0 0 10 12Z" clip-rule="evenodd" />
                </svg>
                <span class="text-xs font-medium mt-1">Perfil</span>
            </button>
        </nav>

        <!-- MODALS -->

        <!-- Modal: Guardar Reunión -->
        <div id="save-meeting-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md">
                <h2 class="text-2xl font-bold text-white mb-4">Guardar Grabación</h2>
                <div class="space-y-4">
                    <div>
                        <label for="meeting-title" class="block text-sm font-medium text-gray-300 mb-1">Título</label>
                        <input type="text" id="meeting-title" class="w-full bg-gray-700 border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:ring-brand focus:border-brand" placeholder="Ej: Reunión Semanal">
                    </div>
                    <div>
                        <label for="meeting-participants" class="block text-sm font-medium text-gray-300 mb-1">Participantes (separados por coma)</label>
                        <input type="text" id="meeting-participants" class="w-full bg-gray-700 border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:ring-brand focus:border-brand" placeholder="Ej: Ana, Juan, María">
                    </div>
                    <div>
                        <label for="meeting-tags" class="block text-sm font-medium text-gray-300 mb-1">Etiquetas (separadas por coma)</label>
                        <input type="text" id="meeting-tags" class="w-full bg-gray-700 border-gray-600 rounded-lg px-3 py-2 text-white placeholder-gray-400 focus:ring-brand focus:border-brand" placeholder="Ej: Q4, Marketing, ProyectoX">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="cancel-save-button" class="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-500 transition-colors">Cancelar</button>
                    <button id="confirm-save-button" class="bg-brand text-white px-4 py-2 rounded-lg font-semibold hover:bg-brand-dark transition-colors">Guardar</button>
                </div>
            </div>
        </div>

        <!-- Modal: Info/Error -->
        <div id="info-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
                <h2 id="info-modal-title" class="text-xl font-bold text-white mb-3"></h2>
                <p id="info-modal-message" class="text-gray-300 mb-5"></p>
                <button id="info-modal-close" class="bg-brand text-white px-6 py-2 rounded-lg font-semibold hover:bg-brand-dark transition-colors">Entendido</button>
            </div>
        </div>

    </div> <!-- Fin de #app-container -->


    <!-- =================================================================================== -->
    <!-- JAVASCRIPT PRINCIPAL DE LA APLICACIÓN -->
    <!-- =================================================================================== -->
    <script type="module">
        // ----------------------------------
        // CONSTANTES Y CONFIGURACIÓN
        // ----------------------------------
        
        // ¡IMPORTANTE! Reemplaza esto con tu propia clave de API de Gemini
        const GEMINI_API_KEY = "AIzaSyCiqpmd1hHjQxkWVlR4VY6zzlycHjBRLkM"; 

        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        
        const DB_NAME = "MeetingMindDB";
        const DB_VERSION = 1;
        
        const STORES = {
            MEETINGS: "meetings",         // Meeting (metadata)
            AUDIO_FILES: "audioFiles",   // AudioFile (blob + metadata)
            TRANSCRIPTS: "transcripts", // Transcript (texto)
            SUMMARIES: "summaries",       // Summary (JSON de IA)
            ACTION_ITEMS: "actionItems"  // ActionItem (extraído de IA)
        };

        // ----------------------------------
        // ESTADO DE LA APLICACIÓN
        // ----------------------------------
        let db;
        let currentUserId = 'mock-user-123'; // Simulación de autenticación
        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        let timerInterval;
        let audioContext;
        let analyser;
        let dataArray;
        let animationFrameId;
        let deferredInstallPrompt = null; // Re-agregado para la instalación
        let currentMeetingBlob = null;
        let currentMeetingDuration = 0;

        // ----------------------------------
        // INICIALIZACIÓN DE PWA (HABILITADA)
        // ----------------------------------
        
        /**
         * Registra el Service Worker desde el archivo externo sw.js.
         */
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('Service Worker registrado con éxito:', registration);
                    })
                    .catch(error => {
                        console.error('Error al registrar el Service Worker:', error);
                    });
            }
        }

        /**
         * Configura el listener para el evento 'beforeinstallprompt'.
         */
        function setupInstallPrompt(e) {
            // Prevenir que el mini-infobar aparezca
            e.preventDefault();
            // Guardar el evento para poder dispararlo después
            deferredInstallPrompt = e;
            // Mostrar nuestro botón de instalación personalizado
            const installButton = document.getElementById('install-pwa-button');
            if (installButton) {
                installButton.classList.remove('hidden');
                console.log('PWA está lista para ser instalada.');
            }
        }

        // ----------------------------------
        // BASE DE DATOS (IndexedDB)
        // ----------------------------------

        /**
         * Inicializa la base de datos IndexedDB.
         * @returns {Promise<IDBDatabase>}
         */
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains(STORES.MEETINGS)) {
                        const meetingsStore = db.createObjectStore(STORES.MEETINGS, { keyPath: 'id', autoIncrement: true });
                        meetingsStore.createIndex('userIdIndex', 'userId', { unique: false });
                        meetingsStore.createIndex('dateIndex', 'startAt', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains(STORES.AUDIO_FILES)) {
                        const audioStore = db.createObjectStore(STORES.AUDIO_FILES, { keyPath: 'id', autoIncrement: true });
                        audioStore.createIndex('meetingIdIndex', 'meetingId', { unique: true });
                    }

                    if (!db.objectStoreNames.contains(STORES.TRANSCRIPTS)) {
                        const transcriptStore = db.createObjectStore(STORES.TRANSCRIPTS, { keyPath: 'id', autoIncrement: true });
                        transcriptStore.createIndex('meetingIdIndex', 'meetingId', { unique: true });
                    }

                    if (!db.objectStoreNames.contains(STORES.SUMMARIES)) {
                        const summaryStore = db.createObjectStore(STORES.SUMMARIES, { keyPath: 'id', autoIncrement: true });
                        summaryStore.createIndex('meetingIdIndex', 'meetingId', { unique: true });
                    }

                    if (!db.objectStoreNames.contains(STORES.ACTION_ITEMS)) {
                        const actionStore = db.createObjectStore(STORES.ACTION_ITEMS, { keyPath: 'id', autoIncrement: true });
                        actionStore.createIndex('meetingIdIndex', 'meetingId', { unique: false });
                        actionStore.createIndex('statusIndex', 'status', { unique: false });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log("Base de datos inicializada:", db);
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error("Error al abrir IndexedDB:", event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        /**
         * Operación genérica para agregar datos a un store.
         */
        function dbAdd(storeName, data) {
            return new Promise((resolve, reject) => {
                if (!db) reject("DB no inicializada");
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.add(data);
                
                request.onsuccess = (event) => resolve(event.target.result); // Devuelve la nueva ID
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        /**
         * Operación genérica para actualizar (put) datos en un store.
         */
        function dbPut(storeName, data) {
            return new Promise((resolve, reject) => {
                if (!db) reject("DB no inicializada");
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        /**
         * Operación genérica para obtener todos los datos de un store.
         */
        function dbGetAll(storeName) {
            return new Promise((resolve, reject) => {
                if (!db) reject("DB no inicializada");
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        /**
         * Operación genérica para obtener datos por ID.
         */
        function dbGet(storeName, id) {
            return new Promise((resolve, reject) => {
                if (!db) reject("DB no inicializada");
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        /**
         * Operación genérica para obtener datos por un índice.
         */
        function dbGetByIndex(storeName, indexName, query) {
            return new Promise((resolve, reject) => {
                if (!db) reject("DB no inicializada");
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const index = store.index(indexName);
                const request = index.get(query);
                
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => reject(event.target.error);
            });
        }

        /**
         * Borra todos los datos de todos los stores.
         */
        async function clearAllData() {
            if (!db) return;
            const transaction = db.transaction(Object.values(STORES), 'readwrite');
            await Promise.all(
                Object.values(STORES).map(storeName => {
                    return new Promise((resolve, reject) => {
                        const store = transaction.objectStore(storeName);
                        const request = store.clear();
                        request.onsuccess = resolve;
                        request.onerror = reject;
                    });
                })
            );
            console.log("Todos los datos han sido borrados.");
        }

        // ----------------------------------
        // LÓGICA DE NAVEGACIÓN
        // ----------------------------------
        
        const pages = document.querySelectorAll('.page');
        const navButtons = document.querySelectorAll('.nav-button');

        function showPage(pageId) {
            // Ocultar todas las páginas
            pages.forEach(page => page.classList.add('hidden'));
            
            // Mostrar la página solicitada
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.remove('hidden');
            }

            // Actualizar estado activo de la barra de navegación (excepto para 'page-detail')
            navButtons.forEach(button => {
                if (button.dataset.page === pageId.replace('page-', '')) {
                    button.classList.add('text-brand-light');
                    button.classList.remove('text-gray-400');
                } else {
                    button.classList.remove('text-brand-light');
                    button.classList.add('text-gray-400');
                }
            });
            
            // Desplazar el contenedor principal al inicio
            document.getElementById('main-content').scrollTop = 0;
            
            // Lógica de actualización al cambiar de página
            if(pageId === 'page-history') {
                renderHistoryList();
            } else if (pageId === 'page-dashboard') {
                renderDashboard();
            }
        }
        
        function setupNavigation() {
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const pageId = `page-${button.dataset.page}`;
                    showPage(pageId);
                });
            });
            
            // Botón de volver en la página de detalle
            document.getElementById('back-to-history').addEventListener('click', () => {
                showPage('page-history');
            });
        }

        // ----------------------------------
        // LÓGICA DE GRABACIÓN
        // ----------------------------------

        function setupRecorder() {
            const recordButton = document.getElementById('record-button');
            const consentCheckbox = document.getElementById('consent-checkbox');

            // Habilitar/Deshabilitar botón según el consentimiento
            consentCheckbox.addEventListener('change', () => {
                recordButton.disabled = !consentCheckbox.checked;
                if(consentCheckbox.checked) {
                    document.getElementById('record-status').textContent = 'Listo para grabar';
                } else {
                    document.getElementById('record-status').textContent = 'Requiere consentimiento';
                }
            });
            
            // Iniciar/Detener grabación
            recordButton.addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                } else {
                    startRecording();
                }
            });
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Configuración del visualizador de audio
                setupAudioVisualizer(stream);
                
                // Opciones del MediaRecorder
                const options = { mimeType: 'audio/webm;codecs=opus' };
                mediaRecorder = new MediaRecorder(stream, options);
                
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    // Detener visualizador
                    stopAudioVisualizer();
                    
                    // Detener stream
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Crear Blob
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const duration = (Date.now() - recordingStartTime) / 1000; // en segundos
                    
                    currentMeetingBlob = audioBlob;
                    currentMeetingDuration = duration;

                    // Limpiar y mostrar modal para guardar
                    document.getElementById('meeting-title').value = `Grabación - ${new Date().toLocaleString()}`;
                    document.getElementById('meeting-participants').value = '';
                    document.getElementById('meeting-tags').value = '';
                    showModal('save-meeting-modal');
                };
                
                recordingStartTime = Date.now();
                mediaRecorder.start();
                
                // Actualizar UI
                updateRecordingUI(true);
                startTimer();

            } catch (err) {
                console.error("Error al iniciar grabación:", err);
                showInfoModal("Error de Micrófono", "No se pudo acceder al micrófono. Asegúrate de haber dado permiso. Si lo bloqueaste, re-habilítalo en la configuración del sitio.");
                updateRecordingUI(false);
            }
        }

        function stopRecording() {
            if (mediaRecorder) {
                mediaRecorder.stop();
                stopTimer();
                updateRecordingUI(false);
            }
        }
        
        /**
         * Configura el visualizador de nivel de audio usando Web Audio API.
         */
        function setupAudioVisualizer(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            
            analyser.fftSize = 32; // Tamaño pequeño para rendimiento
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
            
            const visualizerBar = document.getElementById('audio-level-visualizer');
            
            function draw() {
                animationFrameId = requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                
                let sum = 0;
                for(let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                let avg = sum / bufferLength;
                
                // Mapear el promedio (0-255) a una escala (0-1)
                let scale = Math.min(1, Math.max(0, (avg - 20) / 100)); // Ajustar sensibilidad
                
                visualizerBar.style.transform = `scaleX(${scale})`;
            }
            draw();
        }
        
        /**
         * Detiene el visualizador de audio.
         */
        function stopAudioVisualizer() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close();
            }
            document.getElementById('audio-level-visualizer').style.transform = 'scaleX(0)';
        }

        /**
         * Actualiza la UI (botón, estado) al grabar/detener.
         */
        function updateRecordingUI(isRecording) {
            const recordButton = document.getElementById('record-button');
            const recordRing = document.getElementById('record-ring');
            const recordStatus = document.getElementById('record-status');
            const recordIcon = document.getElementById('record-icon');
            const stopIcon = document.getElementById('stop-icon');

            // Comprobar que los elementos existen antes de usarlos
            if (!recordButton || !recordRing || !recordStatus || !recordIcon || !stopIcon) {
                console.error("Error: Faltan elementos de la UI de grabación.");
                return;
            }
            
            if (isRecording) {
                // Ocultar mic, mostrar stop
                recordIcon.classList.add('hidden');
                stopIcon.classList.remove('hidden');
                
                // Cambiar color botón y mostrar anillo
                recordButton.classList.add('bg-red-900/50');
                recordButton.classList.remove('bg-gray-800');
                recordRing.classList.remove('hidden'); 
                recordStatus.textContent = 'Grabando...';
            } else {
                // Ocultar stop, mostrar mic
                recordIcon.classList.remove('hidden');
                stopIcon.classList.add('hidden');

                // Resetear color botón y ocultar anillo
                recordButton.classList.remove('bg-red-900/50');
                recordButton.classList.add('bg-gray-800');
                recordRing.classList.add('hidden');
                recordStatus.textContent = 'Listo para grabar';
            }
        }

        /**
         * Inicia el cronómetro en pantalla.
         */
        function startTimer() {
            const timerElement = document.getElementById('timer');
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                const hours = String(Math.floor(elapsed / 3600)).padStart(2, '0');
                const minutes = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
                const seconds = String(elapsed % 60).padStart(2, '0');
                timerElement.textContent = `${hours}:${minutes}:${seconds}`;
            }, 1000);
        }

        /**
         * Detiene y resetea el cronómetro.
         */
        function stopTimer() {
            clearInterval(timerInterval);
            document.getElementById('timer').textContent = '00:00:00';
        }

        // ----------------------------------
        // LÓGICA DE MODALES
        // ----------------------------------
        
        function setupModals() {
            // Modal de Guardar Reunión
            const saveModal = document.getElementById('save-meeting-modal');
            document.getElementById('cancel-save-button').addEventListener('click', () => {
                hideModal('save-meeting-modal');
                currentMeetingBlob = null;
                currentMeetingDuration = 0;
            });
            document.getElementById('confirm-save-button').addEventListener('click', handleSaveMeeting);
            
            // Modal de Información
            const infoModal = document.getElementById('info-modal');
            document.getElementById('info-modal-close').addEventListener('click', () => hideModal('info-modal'));
        }
        
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        function showInfoModal(title, message) {
            document.getElementById('info-modal-title').textContent = title;
            document.getElementById('info-modal-message').textContent = message;
            showModal('info-modal');
        }

        // ----------------------------------
        // LÓGICA DE REUNIONES (CRUD)
        // ----------------------------------
        
        /**
         * Maneja el guardado de la reunión desde el modal.
         */
        async function handleSaveMeeting() {
            const title = document.getElementById('meeting-title').value || 'Grabación sin título';
            const participantsStr = document.getElementById('meeting-participants').value;
            const tagsStr = document.getElementById('meeting-tags').value;
            
            const participants = participantsStr ? participantsStr.split(',').map(p => p.trim()) : [];
            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()) : [];
            
            const meetingData = {
                userId: currentUserId,
                title: title,
                startAt: new Date(recordingStartTime).toISOString(),
                endAt: new Date(recordingStartTime + currentMeetingDuration * 1000).toISOString(),
                duration: currentMeetingDuration,
                tags: tags,
                participants: participants,
                isSensitive: false,
                createdAt: new Date().toISOString(),
                status: 'grabado' // grabado -> transcrito -> resumido
            };

            try {
                // 1. Guardar metadatos de la reunión
                const meetingId = await dbAdd(STORES.MEETINGS, meetingData);
                
                // 2. Guardar el archivo de audio
                const audioFileData = {
                    meetingId: meetingId,
                    audioBlob: currentMeetingBlob, // Guardamos el Blob directamente
                    codec: currentMeetingBlob.type,
                    sizeBytes: currentMeetingBlob.size,
                    createdAt: new Date().toISOString()
                };
                await dbAdd(STORES.AUDIO_FILES, audioFileData);
                
                // 3. Limpiar y navegar
                hideModal('save-meeting-modal');
                currentMeetingBlob = null;
                currentMeetingDuration = 0;
                document.getElementById('consent-checkbox').checked = false;
                document.getElementById('record-button').disabled = true;
                
                showInfoModal("Éxito", "La reunión se ha guardado localmente.");
                showPage('page-history'); // Navega al historial para ver la nueva reunión
                
            } catch (error) {
                console.error("Error al guardar la reunión:", error);
                showInfoModal("Error", "No se pudo guardar la reunión en la base de datos local.");
            }
        }
        
        /**
         * Renderiza la lista del historial.
         */
        async function renderHistoryList() {
            const historyList = document.getElementById('history-list');
            const emptyState = document.getElementById('history-empty-state');
            
            try {
                const meetings = (await dbGetAll(STORES.MEETINGS)).reverse(); // Más recientes primero
                
                if (meetings.length === 0) {
                    emptyState.classList.remove('hidden');
                    historyList.innerHTML = '';
                    return;
                }
                
                emptyState.classList.add('hidden');
                historyList.innerHTML = meetings.map(meeting => {
                    const duration = new Date(meeting.duration * 1000).toISOString().substr(11, 8);
                    const date = new Date(meeting.startAt).toLocaleString('es-ES', { dateStyle: 'medium', timeStyle: 'short' });
                    
                    const tagsHtml = meeting.tags.map(tag => 
                        `<span class="text-xs bg-brand-dark text-brand-light px-2 py-0.5 rounded-full">${tag}</span>`
                    ).join(' ');

                    let statusHtml = '';
                    if (meeting.status === 'resumido') {
                        statusHtml = `<span class="mt-2 text-xs font-medium text-green-400 bg-green-900/50 px-2 py-1 rounded-full inline-block">Resumido</span>`;
                    } else if (meeting.status === 'transcrito') {
                        statusHtml = `<span class="mt-2 text-xs font-medium text-yellow-400 bg-yellow-900/50 px-2 py-1 rounded-full inline-block">Transcrito</span>`;
                    } else {
                        statusHtml = `<span class="mt-2 text-xs font-medium text-gray-400 bg-gray-700/50 px-2 py-1 rounded-full inline-block">Grabado</span>`;
                    }

                    return `
                        <li class="bg-gray-800 p-4 rounded-lg shadow-md cursor-pointer hover:bg-gray-700 transition-colors" data-meeting-id="${meeting.id}">
                            <h3 class="font-semibold text-white text-lg">${meeting.title}</h3>
                            <p class="text-sm text-gray-400">${date} (${duration})</p>
                            <div class="flex flex-wrap gap-2 mt-2">${tagsHtml}</div>
                            ${statusHtml}
                        </li>
                    `;
                }).join('');
                
                // Agregar event listeners a los items
                historyList.querySelectorAll('li').forEach(item => {
                    item.addEventListener('click', () => {
                        const meetingId = parseInt(item.dataset.meetingId);
                        renderMeetingDetail(meetingId);
                        showPage('page-detail');
                    });
                });
                
            } catch (error) {
                console.error("Error al renderizar historial:", error);
                emptyState.classList.remove('hidden');
                historyList.innerHTML = '';
            }
        }
        
        /**
         * Renderiza la página de detalle de una reunión.
         * @param {number} meetingId
         */
        async function renderMeetingDetail(meetingId) {
            try {
                // Resetear UI
                document.getElementById('summary-content').classList.add('hidden');
                document.getElementById('summary-empty-state').classList.remove('hidden');
                document.getElementById('transcript-content').classList.add('hidden');
                document.getElementById('transcript-empty-state').classList.remove('hidden');
                document.getElementById('actions-content').classList.add('hidden');
                document.getElementById('actions-empty-state').classList.remove('hidden');
                document.getElementById('ai-loading-spinner').classList.add('hidden');
                document.getElementById('process-ai-button').classList.remove('hidden');
                document.getElementById('process-ai-button').disabled = false;
                
                // 1. Obtener Metadatos de la Reunión
                const meeting = await dbGet(STORES.MEETINGS, meetingId);
                if (!meeting) throw new Error("Reunión no encontrada");

                document.getElementById('detail-title').textContent = meeting.title;
                document.getElementById('detail-date').textContent = new Date(meeting.startAt).toLocaleString('es-ES', { dateStyle: 'long', timeStyle: 'short' });
                document.getElementById('detail-tags').innerHTML = meeting.tags.map(tag => 
                    `<span class="text-xs bg-brand-dark text-brand-light px-2 py-0.5 rounded-full">${tag}</span>`
                ).join(' ');

                // 2. Obtener Archivo de Audio
                const audioFile = await dbGetByIndex(STORES.AUDIO_FILES, 'meetingIdIndex', meetingId);
                const audioPlayer = document.getElementById('detail-audio-player');
                if (audioFile && audioFile.audioBlob) {
                    const audioUrl = URL.createObjectURL(audioFile.audioBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.onended = () => URL.revokeObjectURL(audioUrl);
                } else {
                    audioPlayer.src = '';
                }

                // 3. Obtener Transcripción (si existe)
                const transcript = await dbGetByIndex(STORES.TRANSCRIPTS, 'meetingIdIndex', meetingId);
                if (transcript) {
                    document.getElementById('transcript-empty-state').classList.add('hidden');
                    document.getElementById('transcript-content').classList.remove('hidden');
                    document.getElementById('transcript-text').value = transcript.text;
                }

                // 4. Obtener Resumen (si existe)
                const summary = await dbGetByIndex(STORES.SUMMARIES, 'meetingIdIndex', meetingId);
                if (summary) {
                    document.getElementById('summary-empty-state').classList.add('hidden');
                    document.getElementById('summary-content').classList.remove('hidden');
                    renderSummary(summary.summaryData);
                    
                    // Deshabilitar botón de IA si ya está procesado
                    document.getElementById('process-ai-button').classList.add('hidden');
                }
                
                // 5. Obtener Tareas (si existen)
                // (Se renderizan como parte de renderSummary, pero aquí se poblaría la pestaña 'Acciones')
                if (summary && summary.summaryData.plan_de_accion) {
                    renderActionItemsTab(summary.summaryData.plan_de_accion);
                }

                // 6. Configurar botón de IA
                document.getElementById('process-ai-button').onclick = () => processMeetingWithAI(meetingId);
                document.getElementById('save-transcript-button').onclick = () => saveTranscriptChanges(meetingId);

                // 7. Configurar Pestañas
                setupDetailTabs();
                showDetailTab('summary'); // Mostrar pestaña de minuta por defecto

            } catch (error) {
                console.error("Error al cargar detalle:", error);
                showInfoModal("Error", "No se pudo cargar el detalle de la reunión.");
                showPage('page-history');
            }
        }
        
        /**
         * Renderiza el contenido del resumen de IA en la UI.
         */
        function renderSummary(data) {
            document.getElementById('summary-overview').textContent = data.resumen_general || 'N/A';
            document.getElementById('summary-objective').textContent = data.objetivo_general || 'N/A';
            
            const participantsList = document.getElementById('summary-participants');
            if (data.desarrollo_por_participante && data.desarrollo_por_participante.length > 0) {
                participantsList.innerHTML = data.desarrollo_por_participante.map(p => 
                    `<li class="text-sm text-gray-200"><strong class="text-white">${p.nombre}:</strong> ${p.aportes}</li>`
                ).join('');
            } else {
                participantsList.innerHTML = `<li class="text-sm text-gray-400">No se detallaron aportes.</li>`;
            }
            
            const keypointsList = document.getElementById('summary-keypoints');
            if (data.puntos_relevantes && data.puntos_relevantes.length > 0) {
                keypointsList.innerHTML = data.puntos_relevantes.map(p => 
                    `<li class="text-sm text-gray-200">${p}</li>`
                ).join('');
            } else {
                keypointsList.innerHTML = `<li class="text-sm text-gray-400">No se extrajeron puntos relevantes.</li>`;
            }
        }
        
        /**
         * Renderiza la pestaña de "Plan de Acción".
         */
        function renderActionItemsTab(actionPlan) {
            const actionsList = document.getElementById('summary-actionplan');
            const actionsEmptyState = document.getElementById('actions-empty-state');
            const actionsContent = document.getElementById('actions-content');

            if (!actionPlan || actionPlan.length === 0) {
                actionsEmptyState.classList.remove('hidden');
                actionsContent.classList.add('hidden');
                return;
            }
            
            actionsEmptyState.classList.add('hidden');
            actionsContent.classList.remove('hidden');

            const priorityColors = {
                'Alta': 'text-red-400 bg-red-900/50',
                'Media': 'text-yellow-400 bg-yellow-900/50',
                'Baja': 'text-blue-400 bg-blue-900/50'
            };
            const statusColors = {
                'Pendiente': 'text-blue-400 bg-blue-900/50',
                'En curso': 'text-purple-400 bg-purple-900/50',
                'Hecha': 'text-green-400 bg-green-900/50'
            };

            actionsList.innerHTML = actionPlan.map(item => `
                <li class="bg-gray-950 p-3 rounded-lg border border-gray-700">
                    <p class="font-medium text-white">${item.tarea}</p>
                    <div class="flex flex-wrap justify-between items-center mt-2 text-sm">
                        <span class="text-gray-300">Responsable: <span class="font-medium text-brand-light">${item.responsable}</span></span>
                        <span class="text-gray-400">Límite: <span class="font-medium text-yellow-400">${item.fecha_limite || 'N/A'}</span></span>
                    </div>
                    <div class="mt-2 flex gap-2">
                        <span class="text-xs font-bold ${priorityColors[item.prioridad] || 'text-gray-400 bg-gray-700'} px-2 py-0.5 rounded-full">${item.prioridad}</span>
                        <span class="text-xs font-bold ${statusColors[item.estado] || 'text-gray-400 bg-gray-700'} px-2 py-0.5 rounded-full">${item.estado}</span>
                    </div>
                </li>
            `).join('');
        }
        
        /**
         * Configura los listeners de las pestañas en la página de detalle.
         */
        function setupDetailTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showDetailTab(button.dataset.tab);
                });
            });
        }
        
        /**
         * Muestra una pestaña específica en la página de detalle.
         */
        function showDetailTab(tabId) {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(btn => {
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('border-brand', 'text-brand');
                    btn.classList.remove('border-transparent', 'text-gray-400');
                } else {
                    btn.classList.remove('border-brand', 'text-brand');
                    btn.classList.add('border-transparent', 'text-gray-400');
                }
            });
            
            tabContents.forEach(content => {
                if (content.id === `tab-${tabId}`) {
                    content.classList.remove('hidden');
                } else {
                    content.classList.add('hidden');
                }
            });
        }

        // ----------------------------------
        // LÓGICA DE IA (GEMINI)
        // ----------------------------------
        
        /**
         * Inicia el pipeline de IA para una reunión.
         * @param {number} meetingId
         */
        async function processMeetingWithAI(meetingId) {
            if (!GEMINI_API_KEY) {
                showInfoModal("Error de Configuración", "La clave API de Gemini no está configurada en el código. No se puede procesar la IA.");
                return;
            }
            
            const aiButton = document.getElementById('process-ai-button');
            const aiSpinner = document.getElementById('ai-loading-spinner');
            
            aiButton.disabled = true;
            aiButton.classList.add(aiButton.getAttribute('class_disabled'));
            aiSpinner.classList.remove('hidden');

            try {
                // --- 1. STT (Speech-to-Text) ---
                // MOCK: En una app real, aquí se enviaría el audio a un servicio de STT
                // (on-device, wasm, o backend). Usamos un mock.
                console.log("Iniciando STT (Simulado)...");
                const mockTranscriptText = `
                    Participante 1 (Ana): Hola a todos. El objetivo de esta reunión es revisar el avance del Proyecto Fénix.
                    Participante 2 (Juan): Hola Ana. Por mi parte, el módulo de login está terminado al 80%.
                    Ana: ¿80%? Pensé que estaría listo para hoy.
                    Juan: Encontré un problema con la API de terceros, pero estará solucionado para este viernes, 10 de noviembre de 2025.
                    Participante 3 (María): Respecto al marketing, la campaña de expectativa está lista. Necesitamos la fecha de lanzamiento.
                    Ana: Entendido. Juan, prioriza la finalización del login. María, prepara la campaña para un lanzamiento tentativo el 20 de noviembre.
                    Juan: De acuerdo.
                    María: Perfecto.
                    Ana: Acordamos entonces: Juan termina el login para el 10 de noviembre. María prepara la campaña para el 20 de noviembre.
                `;
                
                // Guardar la transcripción (mock) en la DB
                const transcriptData = {
                    meetingId: meetingId,
                    language: 'es',
                    text: mockTranscriptText,
                    createdAt: new Date().toISOString()
                };
                await dbAdd(STORES.TRANSCRIPTS, transcriptData);
                
                // Actualizar UI de transcripción
                document.getElementById('transcript-empty-state').classList.add('hidden');
                document.getElementById('transcript-content').classList.remove('hidden');
                document.getElementById('transcript-text').value = mockTranscriptText;
                
                // Actualizar estado de la reunión
                await updateMeetingStatus(meetingId, 'transcrito');
                
                // --- 2. Resumen con Gemini ---
                console.log("Llamando a Gemini para resumen...");
                
                const meeting = await dbGet(STORES.MEETINGS, meetingId);
                const summaryData = await getGeminiSummary(mockTranscriptText, meeting);
                
                // Corregir fecha y hora en los datos de IA (ya que el schema no puede hacerlo)
                summaryData.fecha = new Date(meeting.startAt).toISOString().split('T')[0];
                summaryData.hora = `${new Date(meeting.startAt).toTimeString().substr(0,5)} - ${new Date(meeting.endAt).toTimeString().substr(0,5)}`;

                // Guardar Resumen y Tareas
                const summaryRecord = {
                    meetingId: meetingId,
                    summaryData: summaryData, // El JSON completo de Gemini
                    topics: summaryData.temas || [],
                    createdAt: new Date().toISOString()
                };
                await dbAdd(STORES.SUMMARIES, summaryRecord);
                
                // Guardar Tareas (ActionItems)
                if (summaryData.plan_de_accion && summaryData.plan_de_accion.length > 0) {
                    for (const item of summaryData.plan_de_accion) {
                        const actionItem = {
                            meetingId: meetingId,
                            title: item.tarea,
                            assignee: item.responsable,
                            dueDate: item.fecha_limite,
                            priority: item.prioridad,
                            status: item.estado,
                            createdAt: new Date().toISOString()
                        };
                        await dbAdd(STORES.ACTION_ITEMS, actionItem);
                    }
                }
                
                // Actualizar estado de la reunión
                await updateMeetingStatus(meetingId, 'resumido');
                
                // --- 3. Actualizar UI ---
                aiSpinner.classList.add('hidden');
                aiButton.classList.add('hidden'); // Ocultar permanentemente
                
                showInfoModal("Éxito", "La reunión ha sido transcrita y resumida con IA.");
                renderMeetingDetail(meetingId); // Recargar la vista de detalle
                
            } catch (error) {
                console.error("Error en el procesamiento de IA:", error);
                showInfoModal("Error de IA", `No se pudo procesar el resumen. ${error.message}`);
                aiSpinner.classList.add('hidden');
                aiButton.disabled = false;
                aiButton.classList.remove(aiButton.getAttribute('class_disabled'));
            }
        }
        
        /**
         * Llama a la API de Gemini para obtener la minuta estructurada.
         * @param {string} transcriptText
         * @param {object} meeting
         * @returns {Promise<object>} El JSON de la minuta.
         */
        async function getGeminiSummary(transcriptText, meeting) {
            
            const schema = {
                type: "OBJECT",
                properties: {
                    "titulo": { "type": "STRING", "description": "Título conciso de la reunión basado en el contenido." },
                    "fecha": { "type": "STRING", "description": "Fecha de la reunión en formato AAAA-MM-DD." },
                    "hora": { "type": "STRING", "description": "Rango de hora (HH:MM - HH:MM)." },
                    "resumen_general": { "type": "STRING", "description": "Resumen ejecutivo de 150-250 palabras." },
                    "objetivo_general": { "type": "STRING", "description": "El propósito principal de la reunión." },
                    "desarrollo_por_participante": {
                        "type": "ARRAY",
                        "items": {
                            "type": "OBJECT",
                            "properties": {
                                "nombre": { "type": "STRING" },
                                "aportes": { "type": "STRING", "description": "Resumen de los puntos clave aportados por esta persona." }
                            },
                            "required": ["nombre", "aportes"]
                        }
                    },
                    "puntos_relevantes": {
                        "type": "ARRAY",
                        "items": { "type": "STRING" },
                        "description": "Lista priorizada de los puntos más importantes discutidos."
                    },
                    "plan_de_accion": {
                        "type": "ARRAY",
                        "items": {
                            "type": "OBJECT",
                            "properties": {
                                "tarea": { "type": "STRING" },
                                "responsable": { "type": "STRING", "description": "Nombre del responsable. Si no está claro, usar 'Por definir'." },
                                "fecha_limite": { "type": "STRING", "description": "Fecha en formato AAAA-MM-DD. Si no se menciona, usar 'null'." },
                                "prioridad": { "type": "STRING", "enum": ["Alta", "Media", "Baja"] },
                                "estado": { "type": "STRING", "enum": ["Pendiente", "En curso", "Hecha"], "description": "Siempre debe ser 'Pendiente' al crearla." }
                            },
                            "required": ["tarea", "responsable", "fecha_limite", "prioridad", "estado"]
                        }
                    },
                    "temas": {
                        "type": "ARRAY",
                        "items": { "type": "STRING" },
                        "description": "Lista de 5-10 temas o palabras clave (keywords) para etiquetado y búsqueda."
                    }
                },
                required: ["titulo", "fecha", "hora", "resumen_general", "objetivo_general", "desarrollo_por_participante", "puntos_relevantes", "plan_de_accion", "temas"]
            };

            const systemPrompt = `Eres un asistente experto que sintetiza reuniones en español a partir de una transcripción.
Tu objetivo es devolver SIEMPRE un único objeto JSON válido que se adhiera estrictamente al esquema proporcionado.
Usa la siguiente información para los campos de fecha y hora:
- fecha: ${new Date(meeting.startAt).toISOString().split('T')[0]}
- hora: ${new Date(meeting.startAt).toTimeString().substr(0,5)} - ${new Date(meeting.endAt).toTimeString().substr(0,5)}

Considera el idioma detectado, corrige errores de transcripción y conserva cifras/fechas/textos literales críticos.
Si hay ambigüedades en la transcripción sobre un punto, marca ese punto con "TODO: verificar".
La transcripción es:
${transcriptText}`;

            const payload = {
                contents: [
                    { parts: [{ text: systemPrompt }] }
                ],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema,
                    temperature: 0.3
                }
            };

            const response = await fetchWithBackoff(GEMINI_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`Error de la API de Gemini: ${response.status} ${errorBody}`);
            }

            const result = await response.json();
            
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
                try {
                    // El texto ya debería ser JSON válido gracias al schema
                    const jsonText = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(jsonText);
                    console.log("Resumen de Gemini recibido:", parsedJson);
                    return parsedJson;
                } catch (e) {
                    console.error("Error al parsear JSON de Gemini:", e, result.candidates[0].content.parts[0].text);
                    throw new Error("La IA devolvió un JSON inválido.");
                }
            } else {
                throw new Error("Respuesta inesperada de la API de Gemini.");
            }
        }
        
        /**
         * Wrapper de Fetch con reintentos y backoff exponencial.
         */
        async function fetchWithBackoff(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok && response.status === 429 && retries > 0) { // 429 Too Many Requests
                    console.warn(`Reintento ${4 - retries} por error 429. Esperando ${delay}ms...`);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Reintento ${4 - retries} por error de red. Esperando ${delay}ms...`);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                throw error;
            }
        }
        
        /**
         * Actualiza el estado de una reunión en la DB.
         * @param {number} meetingId
         * @param {string} status ('grabado', 'transcrito', 'resumido')
         */
        async function updateMeetingStatus(meetingId, status) {
            const meeting = await dbGet(STORES.MEETINGS, meetingId);
            if (meeting) {
                meeting.status = status;
                await dbPut(STORES.MEETINGS, meeting);
                console.log(`Estado de reunión ${meetingId} actualizado a ${status}`);
            }
        }
        
        /**
         * Guarda los cambios manuales en la transcripción.
         * @param {number} meetingId
         */
        async function saveTranscriptChanges(meetingId) {
            try {
                const transcript = await dbGetByIndex(STORES.TRANSCRIPTS, 'meetingIdIndex', meetingId);
                if(transcript) {
                    transcript.text = document.getElementById('transcript-text').value;
                    await dbPut(STORES.TRANSCRIPTS, transcript);
                    showInfoModal("Éxito", "Cambios en la transcripción guardados.");
                } else {
                    showInfoModal("Error", "No se encontró la transcripción para guardar.");
                }
            } catch (error) {
                console.error("Error al guardar transcripción:", error);
                showInfoModal("Error", "No se pudieron guardar los cambios.");
            }
        }

        // ----------------------------------
        // LÓGICA DEL DASHBOARD
        // ----------------------------------

        async function renderDashboard() {
            try {
                const meetings = await dbGetAll(STORES.MEETINGS);
                const summaries = await dbGetAll(STORES.SUMMARIES);
                const allActionItems = await dbGetAll(STORES.ACTION_ITEMS);
                
                // --- KPI: Tiempo Total (últimos 30 días) ---
                const now = new Date();
                const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                
                const recentMeetings = meetings.filter(m => new Date(m.startAt) > thirtyDaysAgo);
                const totalSeconds = recentMeetings.reduce((sum, m) => sum + m.duration, 0);
                const totalHours = Math.floor(totalSeconds / 3600);
                const totalMinutes = Math.floor((totalSeconds % 3600) / 60);
                document.getElementById('kpi-total-time').textContent = `${totalHours}h ${totalMinutes}m`;
                
                // --- KPI: % con Plan de Acción ---
                const meetingsWithSummary = summaries.length;
                const meetingsWithActionPlan = summaries.filter(s => s.summaryData.plan_de_accion && s.summaryData.plan_de_accion.length > 0).length;
                const actionPlanPct = meetingsWithSummary > 0 ? (meetingsWithActionPlan / meetingsWithSummary) * 100 : 0;
                document.getElementById('kpi-action-items-pct').textContent = `${actionPlanPct.toFixed(0)}%`;

                // --- KPI: Efectividad (Mock) ---
                // En la app real, esto usaría la fórmula de la sección 7.
                // Aquí, solo promediamos si existe.
                const scores = summaries.map(s => s.summaryData.effectivenessScore).filter(Boolean); // Asumiendo que la IA lo añade
                if(scores.length > 0) {
                     const avgEffectiveness = scores.reduce((a, b) => a + b, 0) / scores.length;
                     document.getElementById('kpi-avg-effectiveness').textContent = `${avgEffectiveness.toFixed(0)}/100`;
                } else {
                    document.getElementById('kpi-avg-effectiveness').textContent = 'N/A';
                }

                // --- Gráfico: Temas Frecuentes ---
                renderTopicsChart(summaries);
                
                // --- Lista: Tareas Abiertas ---
                renderOpenTasks(allActionItems);

            } catch (error) {
                console.error("Error al renderizar dashboard:", error);
            }
        }
        
        function renderTopicsChart(summaries) {
            const topicsContainer = document.getElementById('topics-chart-container');
            const topicsEmptyState = document.getElementById('topics-empty-state');
            
            const topicCounts = summaries
                .flatMap(s => s.summaryData.temas || [])
                .reduce((acc, topic) => {
                    acc[topic] = (acc[topic] || 0) + 1;
                    return acc;
                }, {});
            
            const sortedTopics = Object.entries(topicCounts).sort(([,a], [,b]) => b - a).slice(0, 5); // Top 5
            
            if (sortedTopics.length === 0) {
                topicsEmptyState.classList.remove('hidden');
                topicsContainer.innerHTML = '';
                topicsContainer.appendChild(topicsEmptyState);
                return;
            }
            
            topicsEmptyState.classList.add('hidden');
            const maxCount = sortedTopics[0][1];
            
            topicsContainer.innerHTML = sortedTopics.map(([topic, count]) => {
                const widthPct = (count / maxCount) * 100;
                return `
                    <div class="w-full mb-2">
                        <div class="flex justify-between text-sm font-medium text-gray-300 mb-1">
                            <span>${topic}</span>
                            <span>${count}</span>
                        </div>
                        <div class="h-2 w-full bg-gray-700 rounded-full">
                            <div class="h-2 bg-brand rounded-full" style="width: ${widthPct}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderOpenTasks(allActionItems) {
            const tasksList = document.getElementById('tasks-list');
            const tasksEmptyState = document.getElementById('tasks-empty-state');
            
            const openTasks = allActionItems.filter(t => t.status !== 'Hecha').slice(0, 10); // Limitar a 10
            
            if (openTasks.length === 0) {
                tasksEmptyState.classList.remove('hidden');
                tasksList.innerHTML = '';
                return;
            }
            
            tasksEmptyState.classList.add('hidden');
            tasksList.innerHTML = openTasks.map(task => `
                <li class="text-sm border-b border-gray-700 pb-2">
                    <span class="font-medium text-white">${task.title}</span>
                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                        <span>Resp: ${task.assignee}</span>
                        <span class="font-medium ${new Date(task.dueDate) < new Date() ? 'text-red-400' : 'text-yellow-400'}">
                            Límite: ${task.dueDate || 'N/A'}
                        </span>
                    </div>
                </li>
            `).join('');
        }
        
        // ----------------------------------
        // LÓGICA DE PERFIL Y DATOS
        // ----------------------------------
        
        function setupProfile() {
            // Botón de Instalación PWA (Habilitado)
            document.getElementById('install-pwa-button').addEventListener('click', async () => {
                if (deferredInstallPrompt) {
                    // Mostrar el prompt de instalación del navegador
                    deferredInstallPrompt.prompt();
                    // Esperar a que el usuario responda
                    const { outcome } = await deferredInstallPrompt.userChoice;
                    console.log(`Respuesta del usuario: ${outcome}`);
                    // Ya no necesitamos el evento
                    deferredInstallPrompt = null;
                    // Ocultar el botón
                    document.getElementById('install-pwa-button').classList.add('hidden');
                }
            });

            // Botón de Borrar Datos
            document.getElementById('clear-data-button').addEventListener('click', async () => {
                // Usar un modal personalizado en lugar de confirm()
                showInfoModal("Confirmación Requerida", "Esto borrará TODAS las grabaciones, transcripciones y resúmenes locales de forma permanente. ¿Estás seguro?");
                
                // Sobrescribir el botón "Entendido" del modal para que actúe como confirmación
                const infoModalCloseBtn = document.getElementById('info-modal-close');
                const newBtn = infoModalCloseBtn.cloneNode(true);
                infoModalCloseBtn.parentNode.replaceChild(newBtn, infoModalCloseBtn);
                
                newBtn.textContent = "Sí, Borrar Todo";
                newBtn.classList.add('bg-red-700', 'hover:bg-red-600');
                newBtn.classList.remove('bg-brand', 'hover:bg-brand-dark');
                
                newBtn.onclick = async () => {
                    try {
                        await clearAllData();
                        hideModal('info-modal');
                        // Resetear el botón del modal
                        resetInfoModalButton();
                        // Actualizar UI
                        renderHistoryList();
                        renderDashboard();
                        showInfoModal("Éxito", "Todos los datos locales han sido borrados.");
                    } catch (error) {
                        console.error("Error al borrar datos:", error);
                        showInfoModal("Error", "No se pudieron borrar los datos.");
                    }
                };
            });
            
            // Botón de Exportar Datos
            document.getElementById('export-data-button').addEventListener('click', exportAllData);
            
            // Llenar ID de usuario (mock)
            document.getElementById('user-id-display').textContent = `ID: ${currentUserId}`;
        }
        
        /**
         * Resetea el botón del modal de información a su estado original.
         */
        function resetInfoModalButton() {
            const infoModalCloseBtn = document.getElementById('info-modal-close');
            const newBtn = infoModalCloseBtn.cloneNode(true);
            infoModalCloseBtn.parentNode.replaceChild(newBtn, infoModalCloseBtn);
            
            newBtn.textContent = "Entendido";
            newBtn.classList.remove('bg-red-700', 'hover:bg-red-600');
            newBtn.classList.add('bg-brand', 'hover:bg-brand-dark');
            newBtn.onclick = () => hideModal('info-modal');
        }

        /**
         * Exporta todos los datos de IndexedDB como un archivo JSON.
         * (Nota: ¡Esto NO exporta los blobs de audio por su tamaño!)
         */
        async function exportAllData() {
            try {
                const meetings = await dbGetAll(STORES.MEETINGS);
                const transcripts = await dbGetAll(STORES.TRANSCRIPTS);
                const summaries = await dbGetAll(STORES.SUMMARIES);
                const actionItems = await dbGetAll(STORES.ACTION_ITEMS);
                
                const exportData = {
                    meetings,
                    transcripts,
                    summaries,
                    actionItems,
                    exportedAt: new Date().toISOString()
                };
                
                const jsonString = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `meetingmind_export_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showInfoModal("Éxito", "Metadatos exportados como JSON. Los audios no se incluyen en esta exportación.");

            } catch (error) {
                console.error("Error al exportar datos:", error);
                showInfoModal("Error", "No se pudieron exportar los datos.");
            }
        }

        // ----------------------------------
        // INICIO DE LA APLICACIÓN
        // ----------------------------------
        
        async function initApp() {
            try {
                await initDB();
                setupNavigation();
                setupRecorder();
                setupModals();
                setupProfile();
                
                // Configurar listener de instalación de PWA (Habilitado)
                window.addEventListener('beforeinstallprompt', setupInstallPrompt);
                
                // Registrar Service Worker (Habilitado)
                registerServiceWorker();

                // Mostrar la página de grabación por defecto
                showPage('page-record');
                document.getElementById('record-button').disabled = true; // Deshabilitado hasta que se marque el consentimiento
                
            } catch (error) {
                console.error("Error al inicializar la aplicación:", error);
                showInfoModal("Error Crítico", "No se pudo iniciar la base de datos local. La app no funcionará correctamente.");
            }
        }
        
        // Iniciar la aplicación cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
